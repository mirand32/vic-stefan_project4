<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Project 4</title>
		<link rel="stylesheet" href="public/styles/style.css">
	</head>
	â€‹

	<body>
		<header>
			<nav>
				<h3>Title of our App</h3>
				<ul>
					<li>About</li>
					<li>Resoures</li>
				</ul>
			</nav>
			<h1>Title of our App</h1>
		</header>
		<section class="intro">
			<h4>Intro-title</h4>
			<p>
				Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quae itaque voluptatibus earum repellat pariatur id officia autem
				sapiente quia quidem quas amet, a modi quo vero blanditiis porro. Consequatur, enim!Nulla iure beatae ipsum non, nisi
				voluptatem accusantium omnis impedit totam laborum pariatur, qui porro! Rerum quidem deleniti animi tenetur! Omnis rem
				nemo, quidem consequuntur sit fuga sapiente perspiciatis eveniet?
			</p>
		</section>
		<section class="search">
        <h4>Search By</h4>
        <form action="">
            <fieldset class="countries">
                <button class="countriesButton"></button>

                <div class="country">
					<label for="vanuatu">Vanuatu
						<input type="checkbox" class="countryNames" value="vanuatu">
					</label>
				</div>

				<div class="country">
					<label for="tonga">Tonga
						<input type="checkbox" class="countryNames" value="tonga">
					</label>
				</div>

				<div class="country">
					<label for="philippines">Philippines
						<input type="checkbox" class="countryNames" value="philippines">
					</label>
				</div>

				<div class="country">
					<label for="guatemala">Guatemala
						<input type="checkbox" class="countryNames" value="guatemala">
					</label>
				</div>

				<div class="country">
					<label for="bangladesh">Bangladesh
						<input type="checkbox" class="countryNames" value="bangladesh">
					</label>
				</div>

				<div class="country">
					<label for="solomon islands">Vanuatu
						<input type="checkbox" class="countryNames" value="solomon islands">
					</label>
				</div>

				<div class="country">
					<label for="brunei">Brunei
						<input type="checkbox" class="countryNames" value="Brunei">
					</label>
				</div>

				<div class="country">
					<label for="costa rica">Costa Rica
						<input type="checkbox" class="countryNames" value="costa rica">
					</label>
				</div>

				<div class="country">
					<label for="cambodia">Cambodia
						<input type="checkbox" class="countryNames" value="cambodia">
					</label>
				</div>

				<div class="country">
					<label for="papa new guinea">Papa New Guinea
						<input type="checkbox" class="countryNames" value="papa new guinea">
					</label>
				</div>

				<div class="country">
					<label for="el salvador">El Salvador
						<input type="checkbox" class="countryNames" value="el salvador">
					</label>
				</div>

				<div class="country">
					<label for="timor-leste">Timor-Leste
						<input type="checkbox" class="countryNames" value="timor-leste">
					</label>
				</div>

				<div class="country">
					<label for="mauritius">Mauritius
						<input type="checkbox" class="countryNames" value="mauritius">
					</label>
				</div>

				<div class="country">
					<label for="nicaragua">Nicaragua
						<input type="checkbox" class="countryNames" value="nicaragua">
					</label>
				</div>

				<div class="country">
					<label for="vguinea-bissau">Guinea-Bissau
						<input type="checkbox" class="countryNames" value="Guinea-Bissau">
					</label>
				</div>

				<div class="country">
					<label for="fiji">Fiji
						<input type="checkbox" class="countryNames" value="fiji">
					</label>
				</div>

				<div class="country">
					<label for="japan">Japan
						<input type="checkbox" class="countryNames" value="japan">
					</label>
				</div>

				<div class="country">
					<label for="vietnam">Vietnam
						<input type="checkbox" class="countryNames" value="vietnam">
					</label>
				</div>

				<div class="country">
					<label for="gambia">Gambia
						<input type="checkbox" class="countryNames" value="gambia">
					</label>
				</div>

				<div class="country">
					<label for="jamaica">Jamaica
						<input type="checkbox" class="countryNames" value="jamaica">
					</label>
				</div>

				<div class="country">
					<label for="haiti">Haiti
						<input type="checkbox" class="countryNames" value="haiti">
					</label>
				</div>

				<div class="country">
					<label for="chile">Chile
						<input type="checkbox" class="countryNames" value="chile">
					</label>
				</div>

				<div class="country">
					<label for="benin">Benin
						<input type="checkbox" class="countryNames" value="benin">
					</label>
				</div>

				<div class="country">
					<label for="guyana">Guyana
						<input type="checkbox" class="countryNames" value="guyana">
					</label>
				</div>

				<div class="country">
					<label for="niger">Niger
						<input type="checkbox" class="countryNames" value="niger">
					</label>
				</div>

				<div class="country">
					<label for="madagascar">Madagascar
						<input type="checkbox" class="countryNames" value="madagascar">
					</label>
				</div>

				<div class="country">
					<label for="dominican republic">Dominican Republic
						<input type="checkbox" class="countryNames" value="dominican republic">
					</label>
				</div>

				<div class="country">
					<label for="cameroon">Cameroon
						<input type="checkbox" class="countryNames" value="cameroon">
					</label>
				</div>

				<div class="country">
					<label for="chad">Chad
						<input type="checkbox" class="countryNames" value="chad">
					</label>
				</div>

				<div class="country">
					<label for="honduras">Honduras
						<input type="checkbox" class="countryNames" value="honduras">
					</label>
				</div>

				<div class="country">
					<label for="cape verde">Cape Verde
						<input type="checkbox" class="countryNames" value="cape verde">
					</label>
				</div>

				<div class="country">
					<label for="senegal">Senegal
						<input type="checkbox" class="countryNames" value="senegal">
					</label>
				</div>

				<div class="country">
					<label for="togo">Togo
						<input type="checkbox" class="countryNames" value="togo">
					</label>
				</div>

				<div class="country">
					<label for="djbouti">Djbouti
						<input type="checkbox" class="countryNames" value="djbouti">
					</label>
				</div>

				<div class="country">
					<label for="burundi">Burundi
						<input type="checkbox" class="countryNames" value="burundi">
					</label>
				</div>

				<div class="country">
					<label for="indonesia">Indonesia
						<input type="checkbox" class="countryNames" value="indonesia">
					</label>
				</div>

				<div class="country">
					<label for="sierra leone">Sierra Leone
						<input type="checkbox" class="countryNames" value="sierra leone">
					</label>
				</div>
            </fieldset>


            <fieldset class="vulnerableGroups">
                <button class="vulnerableGroupButton"></button>

                <div class="vulnerableGroup">
                    <label for="6870">Aged Persons
                        <input type="checkbox" class="vulnerableGroupNames" value="6870">
                    </label>
                </div>
                
                <div class="vulnerableGroup">
                    <label for="6871" >Children
                        <input type="checkbox" class="vulnerableGroupNames" value="6871">
                    </label>
                </div>

                <div class="vulnerableGroup">
                    <label for="6872">Internationally Displaced Persons (IDPs)
                        <input type="checkbox" class="vulnerableGroupNames" value="6872">
                    </label>
                </div>

                <div class="vulnerableGroup">
                    <label for="6873">Persons with Disabilities
                        <input type="checkbox" class="vulnerableGroupNames" value="6873">
                    </label>
                </div>

                <div class="vulnerableGroup">
                    <label for="6874">Refugees
                        <input type="checkbox" class="vulnerableGroupNames" value="6874">
                    </label>
                </div>

                <div class="vulnerableGroup">
                    <label for="6875" id="6875">Women
                        <input type="checkbox" class="vulnerableGroupNames" value="6875">
                    </label>
                </div>
            </fieldset>
			<button class="submitSearch">Submit</button>
			<button class="readMore">Read More</button>
        </form>
	</section>
		<script src='https://code.jquery.com/jquery-3.2.1.min.js' integrity='sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4='
		crossorigin='anonymous'></script>
		<!-- <script src="public/scripts/main.js"></script> -->
		<script>
			// Save API URL
			const apiURL = 'https://api.reliefweb.int/v1/reports?appname=apidoc';

			// Relief App Variables
			const app = {};
			const searchGroupKey = [];
			const searchCountryKey = [];
			let resultsData=[];
			let finalResults=[];	


			// Method to initialize events 
			app.events = function () {
				//Save countries the user clicks on to an array
				$(".countryNames").on("click", function () {	
					const countryNameInput = $(this).val();
					if ($(this).is(':checked')) {
						searchCountryKey.push(countryNameInput);
						//Allow user to remove country from array 
					} else {
						const removeCountryName = searchCountryKey.indexOf(countryNameInput);
						return searchCountryKey.splice(removeCountryName, 1);
					}
				});
				//Save vulnerable groups the user clicks to an array
					$('.vulnerableGroupNames').on('change', function () {
					const vulnerableGroupInput = $(this).val();
					if ($(this).is(':checked')) {
						searchGroupKey.push(vulnerableGroupInput);
						//allow user to remove groups from the array
					} else {
						const removeVulnerableGroup = searchGroupKey.indexOf(vulnerableGroupInput);
						return searchGroupKey.splice(removeVulnerableGroup, 1);
					};
				})
				
				//Listen for when submit button is clicked to get their results
				$(".submitSearch").on("click", async function(e){
					//prevent default of submit button
					e.preventDefault();
					//make ajax request to get data based on users queries and save that to a variable
					const countryData=await app.getDisasterInfoCountries(searchCountryKey);
					//Once data is recieved back continue
					$.when(
						countryData[0]
					//Take the results of ajax request and manipulate it
					).then(function (country) {
						const resultsData=(country.data);
						console.log(resultsData);
						//Iterate through each result to save results into a more accessible array
						for(let i=0;i<resultsData.length;i++){
							//Create object in the array that will hold all the properties for that disaster
							var disasterName = resultsData[i].fields.disaster[0].name;
							//put disaster name into object
							finalResults.push({disasterName});
							//put disaster category into the object
							finalResults[i].disasterType=resultsData[i].fields.disaster[0].type[0].name;
							//put disaster type into the object
							finalResults[i].date=resultsData[i].fields.date.original;
							//put all the countries into an array in the object
							let countries=[]
							for(let x=0;x<resultsData[i].fields.country.length;x++){
								countries.push(resultsData[i].fields.country[x].name);
							}
							finalResults[i].countries=countries;
							//put all the vulnerable groups into an array in the object
							let vulnerableGroups = []
							for(let x=0;x < resultsData[i].fields.vulnerable_groups.length; x++) {
								vulnerableGroups.push(resultsData[i].fields.vulnerable_groups[x].name);
							};
							finalResults[i].vulnerableGroups=vulnerableGroups;
						};

						//create function that will remove duplicate disasters from Array
						function removeDuplicates(originalArray, prop) {
							var finalResults = [];
							var lookupObject = {};
							for (var i in originalArray) {
								lookupObject[originalArray[i][prop]] = originalArray[i];
							}
							for (i in lookupObject) {
								finalResults.push(lookupObject[i]);
							}
							return finalResults;
						}
						//call function to filter results
						let filteredFinalResults = removeDuplicates(finalResults, "disasterName");
						console.log(filteredFinalResults);
					})
				})
				
				//Create a read more button that will generate articles for the given disaster
				$(".readMore").on("click", async function (e) {
					e.preventDefault();
					const getArticles = await app.getArticles("Indonesia: Earthquakes - Jul 2018");
					$.when(
						getArticles
					).then(function (article) {
						console.log(article);
					})
				})
			}

			// Method to GET disaster info by Country
			app.getDisasterInfoCountries = (...query) => {
				query = query.map((item) => {
					return $.ajax({
						url: apiURL,
						method: 'GET',
						dataType: 'json',
						data: {

							"filter": {
								operator: 'AND',
								conditions: [
									{
										"field": "country",
										"value": item,
									},
									{
										"field": 'vulnerable_groups.id',
										"value": searchGroupKey,
										"operator":"OR" 
									},
									{
										"field":"disaster.name"
									},
									{
										"field":"disaster.type.name"
									}
								],

							},	

							"fields": {
								"include": [
									"disaster.name", 
									"disaster.type.name", 
									"date.original", 
									"country.name", 
									"vulnerable_groups.name"
								]
							},

							"language": {
								"id": 267,
								"name": "English",
								"code": "en"
							},

							"limit": 1000,
							"preset": "latest",

							"query": {
								"value": 'analysis latest'
							}
						}
					})
				})
				return $.when(query);
			}
			
			//Method to get Articles by the disaster name
			app.getArticles = (disaster) => {
						articles = $.ajax({
							url: apiURL,
							method: 'GET',
							dataType: 'json',
							data: {

								"filter": {
									operator: 'AND',
									conditions: [
										{
											"field": "disaster.name",
											"value": disaster,
										},
										{
											"field": 'vulnerable_groups.id',
											"value": searchGroupKey,
											"operator": "OR"
										},
									],

								},

								"fields": {
									"include": [
										"headline.title",
										"body-html",
										"origin"
									]
								},

								"language": {
									"id": 267,
									"name": "English",
									"code": "en"
								},

								"limit": 10,
								"preset": "latest",

								"query": {
									"value": 'analysis latest'
								}
							}
						})
					return $.when(articles);
				}

			// Init function to initialize app 
			app.init = function () {
				$('form')[0].reset();
				app.events();
			}


			// DOC READY
			$(function () {

				// Call init function
				app.init();
				// delete
			})

		</script>
	</body>
	</html>